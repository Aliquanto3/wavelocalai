# CONTEXTE & OBJECTIF
Tu es un Lead QA Engineer expert en Python, pytest et unittest.mock.
Je d√©veloppe "WaveLocalAI", une application d'IA locale avec :
- Code m√©tier : `src/core/`
- Interface : `src/app/`

**TON OBJECTIF** : Analyser les tests existants (s'ils existent) puis g√©n√©rer/am√©liorer une suite de tests compl√®te en pytest pour maximiser la couverture du code m√©tier (`src/core/`).

---

# PHASE 1 : ANALYSE PR√âALABLE

## √âtape 1.1 : D√©tection des tests existants
V√©rifie si des tests existent d√©j√† dans le code fourni :
- Cherche les fichiers `test_*.py` ou `*_test.py`
- Identifie le dossier `tests/` s'il existe
- R√©pertorie les modules d√©j√† test√©s

## √âtape 1.2 : √âvaluation de la qualit√© (si tests existants)
Pour chaque fichier de test trouv√©, analyse :

### Couverture
- ‚úÖ Quelles fonctions/classes sont test√©es ?
- ‚ùå Quelles fonctions/classes manquent ?
- üìä Estimation du % de couverture par module

### Qualit√© des tests
- **Mocking** : Les appels externes sont-ils mock√©s ?
- **Cat√©gories** : Happy Path / Edge Cases / Error Handling sont-ils couverts ?
- **Nommage** : Les noms de tests sont-ils descriptifs ?
- **Isolation** : Les tests sont-ils ind√©pendants ?
- **Assertions** : Sont-elles explicites et compl√®tes ?

## √âtape 1.3 : Rapport d'analyse
Produis un rapport structur√© :
````
## ANALYSE DES TESTS EXISTANTS

### Fichiers d√©tect√©s
- tests/unit/test_models_db.py (15 tests)
- tests/unit/test_agent_tools.py (8 tests)

### Couverture estim√©e par module
- models_db.py : 70% ‚úÖ
- agent_tools.py : 40% ‚ö†Ô∏è
- rag_engine.py : 0% ‚ùå
- agent_engine.py : 0% ‚ùå

### Points forts
- Bon usage des mocks dans test_models_db.py
- Tests bien nomm√©s et document√©s

### Points d'am√©lioration
- Manque de tests pour les edge cases dans agent_tools.py
- Pas de tests d'erreur pour les appels API
- rag_engine.py et agent_engine.py non test√©s

### Recommandations
1. Compl√©ter agent_tools.py avec 5 tests suppl√©mentaires
2. Cr√©er test_rag_engine.py (priorit√© haute)
3. Cr√©er test_agent_engine.py (priorit√© haute)
````

---

# PHASE 2 : G√âN√âRATION/AM√âLIORATION

## Si AUCUN test n'existe
‚Üí Passe directement √† la g√©n√©ration compl√®te (voir section "Modules √† tester")

## Si des tests EXISTENT
‚Üí Applique la strat√©gie suivante :

### Strat√©gie d'am√©lioration
1. **CONSERVER** : Ne r√©√©cris pas les tests existants de bonne qualit√©
2. **AM√âLIORER** : Propose des versions am√©lior√©es pour les tests faibles (avec commentaires expliquant les changements)
3. **COMPL√âTER** : Ajoute les tests manquants pour atteindre une couverture compl√®te

### Format de livraison hybride
Pour chaque fichier :
````python
# tests/unit/test_models_db.py

# ========================================
# TESTS EXISTANTS CONSERV√âS (Bonne qualit√©)
# ========================================
# [Coller les tests existants conserv√©s]

# ========================================
# TESTS AM√âLIOR√âS (Qualit√© insuffisante)
# ========================================
# AVANT (comment√©) :
# def test_old_version():
#     # Probl√®me : pas de mock, assertion faible
#     result = fonction()
#     assert result

# APR√àS (am√©lior√©) :
def test_improved_version():
    """V√©rifie [comportement] avec mock et assertions explicites"""
    with patch('module.externe') as mock_ext:
        mock_ext.return_value = "valeur attendue"
        result = fonction()
        assert result == "valeur attendue", "Message explicite"
        mock_ext.assert_called_once()

# ========================================
# TESTS AJOUT√âS (Couverture manquante)
# ========================================
def test_new_edge_case_empty_input():
    """Nouveau test : gestion des entr√©es vides"""
    # Given, When, Then
````

---

# MODULES √Ä TESTER (par ordre de priorit√©)

## 1. `src/core/models_db.py`
- R√©cup√©ration des informations des mod√®les
- Filtrage et recherche
- Gestion des cas d'erreur (mod√®le inexistant, donn√©es corrompues)

## 2. `src/core/agent_tools.py`
- Calculatrice : op√©rations valides + gestion d'erreurs (division par z√©ro, syntaxe invalide)
- Search : retours corrects + gestion timeout/erreurs r√©seau
- Validation des inputs (types, valeurs limites)

## 3. `src/core/rag_engine.py`
- Ingestion de documents (mock ChromaDB, pas d'appel r√©el)
- Recherche s√©mantique (mock des embeddings et r√©sultats)
- Edge cases : documents vides, formats invalides, erreurs ChromaDB

## 4. `src/core/agent_engine.py`
- Parsing des r√©ponses LLM : extraction balises `<think>`, `<tool_call>`
- D√©tection et validation des tool calls
- Gestion des r√©ponses malform√©es ou incompl√®tes

---

# CONTRAINTES STRICTES

## Mocking obligatoire
- ‚úÖ Mock TOUS les appels externes avec `unittest.mock.patch`
- ‚ùå AUCUN appel r√©el √† Ollama API
- ‚ùå AUCUN appel r√©el √† ChromaDB
- ‚úÖ Utilise `tmp_path` (fixture pytest) pour tests filesystem si n√©cessaire

## Organisation des tests
Pour chaque module, structure ainsi :
````python
# tests/unit/test_[module].py

class TestNomClasse:
    """Tests pour [description]"""

    # Happy Path
    def test_nominal_case_1(self):
        """V√©rifie [comportement attendu]"""
        # Given, When, Then

    # Edge Cases
    def test_edge_empty_input(self):
        """V√©rifie la gestion des entr√©es vides"""

    def test_edge_invalid_type(self):
        """V√©rifie la gestion des types invalides"""

    # Error Cases
    def test_error_external_service_fails(self):
        """V√©rifie la gestion des pannes de service externe"""
````

## Bonnes pratiques
- Utilise des assertions explicites : `assert result == expected, "message clair"`
- Nomme les tests de fa√ßon descriptive : `test_[action]_[condition]_[resultat_attendu]`
- Isole chaque test (pas de d√©pendances inter-tests)
- Ajoute des docstrings pour les cas complexes

---

# FORMAT DE LIVRABLE

Fournis les fichiers de tests complets et op√©rationnels :
````
tests/
‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îú‚îÄ‚îÄ test_models_db.py      # Tests pour models_db.py (conserv√©s + am√©lior√©s + ajout√©s)
‚îÇ   ‚îú‚îÄ‚îÄ test_agent_tools.py    # Tests pour agent_tools.py (conserv√©s + am√©lior√©s + ajout√©s)
‚îÇ   ‚îú‚îÄ‚îÄ test_rag_engine.py     # Tests pour rag_engine.py (nouveaux)
‚îÇ   ‚îî‚îÄ‚îÄ test_agent_engine.py   # Tests pour agent_engine.py (nouveaux)
‚îî‚îÄ‚îÄ conftest.py                # Fixtures partag√©es (si n√©cessaire)
````

Chaque fichier doit :
1. Importer les d√©pendances n√©cessaires
2. D√©finir les fixtures locales si besoin
3. Contenir au minimum 3 cat√©gories de tests : Happy Path, Edge Cases, Error Handling
4. √ätre ex√©cutable imm√©diatement avec `pytest tests/unit/`

---

# INSTRUCTIONS D'EX√âCUTION

1. **D√©tecte** les tests existants dans le code fourni
2. **Analyse** leur qualit√© et produis le rapport d'analyse
3. **Identifie** les fonctions/classes critiques de chaque module non/mal test√©es
4. **G√©n√®re** les tests manquants en suivant la structure d√©finie
5. **Am√©liore** les tests existants de qualit√© insuffisante (avec explications)
6. **Ajoute** des commentaires pour les mocks complexes
7. **V√©rifie** que chaque test est autonome et r√©p√©table

**COMMENCE MAINTENANT** :
1. D'abord, produis le rapport d'analyse des tests existants
2. Ensuite, g√©n√®re/am√©liore la suite de tests compl√®te
